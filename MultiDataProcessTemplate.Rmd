---
title: "MultiDataProcessLogWW"
author:
- Laurel Genge
- Carlie Barnhill
- Max Berthold
- Douglas A. Campbell
- Mireille Savoie
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: Prochlorococcus_O2_NPQ.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

## Set figure caption font size
```{css, echo=FALSE}
p.caption {
  font-size: 18px;
}
```

## Set Chunk Options
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Implement logistic growth curve fits to MultiCulti growth trajectories.

# Load Libraries and set project variables
Run only first time in session


```{r load libraries}
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(zoo)
#library(tidyquant)
#library(data.table)
#library(googledrive)
#library(googlesheets4)
library(minpack.lm)
#library(dplyr)

#attach psych for harmonic.mean() for averaging rates
#library(psych)
library(RcppRoll)  #used for rolling mean
```

Run only first time in session

```{r set project variables}
#"..", takes up a level in the directory path
Project <- "PICO"
DataIn <- file.path("..","ImportedData")
PlotsPath <- file.path("..","Plots")
DataOut <- file.path("..","ProcessedData", "LogGrowthFits")
MetaCatalog <- file.path("..","PicoCatalog.csv")

TruncFactor <- 0.5

GrowthFlagError <- 0.1

Sensor <- "od-680"


#set the hour of day at which photoperiod starts for later generation of ToD Time of Day
#replaced by extraction of StartHour from first row of data file in MultiDataImport.Rmd
#StartHour <- 6
#EndHour <- 18

```

Run only first time in session

```{r set colours}
MyWavelengths = c(405, 450, 475, 530, 615, 660, 730, "WW")
MCMIXColours = c("violet", "darkblue", "dodgerblue", "green","orange","red","purple", "black")

names(MCMIXColours) <- MyWavelengths
MCMIXColours
```



# List previously processed files

Run only first time in session

```{r previously processed files}
list.files(path = DataOut, pattern = Project, full.names = TRUE)

```

# List available tidied, organized .Rds files of MultiCulti data.

Exported from runs of MultiDataImport.Rmd Run only first time in session

```{r list tidied data files}
list.files(path = DataIn, pattern = Project, full.names = TRUE)

```

# Select and Read ProcessFile

Run for each file in a session; all chunks below run for each file.

```{r read ProcessFile}
ProcessFile <- "../ImportedData/20220125_PICO_MCMIX004_RUN47_TargetDataMetaFilter.Rds"

ProcessFileName <- str_split(string = ProcessFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") %>%
  str_remove(pattern = "_TargetDataMetaFilter")

ProcessData <- readRDS(ProcessFile)  %>%
  ungroup()

colnames(ProcessData)
```

Remove extraneous columns from ProcessData; could have been done at end of MultiDataImport.Rmd
```{r clean up ProcessData}
ProcessData <- ProcessData %>%
  #select(-contains("actinic-lights.light")) %>%
  select(-c("Plate", "Well", "MovAvg680", "MovAvg720",  "IsMovAvgOutlier680", "IsMovAvgOutlier720","ActinicMin_parOD680",          
"ActinicMid_parOD680", "ActinicMin_parOD720", "ActinicMid_intervalOD720" ))

colnames(ProcessData)

```

Add deltaOD columns; filter for failed ln
```{r add ln and deltaOD columns}
ProcessData <- ProcessData %>%
  #drop_na(Tube, MC, ExpDate) %>%
  mutate(deltaOD = OD680 - OD720) %>%
  # Script fails at line 149 for WL runs, MC column are all NAs so all data is filtered out
  filter(!is.infinite(log(OD720))) %>%
  filter(!is.infinite(log(OD680))) %>%
  filter(!is.infinite(log(deltaOD))) %>%
  filter(!is.nan(log(OD720))) %>%
  filter(!is.nan(log(OD680))) %>%
  filter(!is.nan(log(deltaOD)))



#lognormOD720 and deltaOD for Gompe
#using RcppRoll functions to find the minimum of a 5 point window to lower noise in normalizations
ProcessData <- ProcessData %>%
  group_by(Tube) %>%
  mutate(rollmeanOD720 = roll_mean(OD720, n = 5, align = "right", fill = NA),
         rollmeandeltaOD = roll_mean(deltaOD, n = 5, align = "right", fill = NA),
         lognormOD720 = log(OD720/min(rollmeanOD720, na.rm = TRUE)),
         lognormdeltaOD = log(deltaOD/min(deltaOD, na.rm = TRUE))
  ungroup()

```


# Generate a plot of the data in the selected tidied MultiCulti file.

```{r prelim ProcessPlot}
#Run <- c("MultiCulti/20200124_PICO_MCMIX004_RUN1.csv", "MultiCulti/20200124_PICO_MCMIX006_RUN2.csv")

ProcessData %>%
  ggplot() +
  geom_point(aes(x = time, y = OD720), size = 0.1) +
  geom_point(aes(x = time, y = Actinic_par/1000, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

ProcessData %>%
  #filter(Tube == 5) %>%
  ggplot() +
  geom_point(aes(x = time, y = log(OD720)), size = 0.1) +
  geom_point(aes(x = time, y = Actinic_par/100, colour = as.factor(WL)), size = 0.05) +
  geom_vline(aes(xintercept = 7 * 24), linetype = "dashed") + 
  geom_vline(aes(xintercept = 14 * 24), linetype = "dashed") + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

ProcessData %>%
 # filter(Tube == 1) %>%
  ggplot() +
  geom_point(aes(x = time, y = deltaOD), size = 0.1) +
  #geom_point(aes(x = time, y = Actinic_par/100, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

ProcessData %>%
 # filter(Tube == 1) %>%
  ggplot() +
  geom_point(aes(x = time, y = lognormOD720), size = 0.1) +
  #geom_point(aes(x = time, y = Actinic_par/100, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()
ProcessData %>%
 # filter(Tube == 1) %>%
  ggplot() +
  geom_point(aes(x = time, y = lognormdeltaOD), size = 0.1) +
  #geom_point(aes(x = time, y = Actinic_par/100, colour = as.factor(WL)), size = 0.05) +
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2), cols = vars(as.factor(Tube), Strain, Par_ue)) +
  theme_bw()

```

# For split files only; select the interval that covers before the change in actinic light
```{r Interval Data for split files}
#even multiples of 24 + StartHour to start at photoperiod
# LowerTime <- 24 * 0
# UpperTime <- 24 * 17
# #
# ProcessData <- ProcessData %>%
#   filter(time <= UpperTime)
```


# Attempt  Fits of Data
Create R function for logistic equation.
Check with Max for alternate formulations that include lag?
Consider which parameter(s) to report for comparison(s) of strain responses to growth conditions
  -mu
  -Pmax
  -other...
```{r logistic function, message = FALSE}
#define a logistic equation as a function.
#x will be taken from 'time' when we run the fit.
logistic_eqn <- function(x, pmax, mu, intercept){(pmax*intercept*exp(mu*x))/(pmax + (intercept*(exp(mu*x)-1)))
}
#Modified Gompertz equation
ModGompertzEqn <- function(x,lag,Gmax,Gmu){(Gmax*(exp(-exp((Gmu*exp(1))/Gmax*(lag-x)+1))))}

# Exponential equation 
exp_eqn <- function(x, mu, intercept){(Intercept*exp(x*mu))}


```

Set global starting values for logistic model
Replaced with 'self-seeding' options that assign start values based upon the actual data
Be careful with lower and upper limits; if inappropriate to data set can force fit to unrealistic outcomes
```{r set global starting values for logistic model, message = FALSE}
#define starting, lower, and upper bounds for fit parameters to constrain logistic fit
# logistic_eqn_start<-list(pmax = max(ProcessData$Areamm2, na.rm = TRUE), mu = 0.05, intercept = min(MyData$Areamm2, na.rm = TRUE))
# 
# logistic_eqn_lower<-c((max(MyData$Areamm2, na.rm = TRUE) * 0.5),0.001,((min(MyData$Areamm2, na.rm = TRUE) * 0.1)))
# 
# logistic_eqn_upper<-c((max(MyData$Areamm2, na.rm = TRUE) * 2),1,((min(MyData$Areamm2, na.rm = TRUE) * 4)))

# logistic_eqn_startOD720 <- list(pmax = max(ProcessData$OD720), mu = 0.01, intercept = min(ProcessData$OD720))
# logistic_eqn_startdeltaOD <- list(pmax = max(ProcessData$deltaOD), mu = 0.01, intercept = min(ProcessData$deltaOD))
# logistic_eqn_lower <- c(0.1, -0.1, 0.001)
# logistic_eqn_upper <- c(1, 0.1, 0.1)
```

Logistic fits across entire data sets; not appropriate for split condition runs

DeBug:
Warning: Problem with `mutate()` column `OD720_logistic`.
ℹ `OD720_logistic = map(...)`.
ℹ lmdif: info = 0. Improper input parameters.

```{r nested logistic regressions }


# FitDataLag <- FitData %>%
#   group_by(!!sym(NestVar), !!sym(RowVar2), !!sym(RowVar), !!sym(ColVar), Wavelength, exp_date) %>%
#   mutate(LagSeed = E_hours[which.min(CorrOD)])

#Use Tube Specific Starting values in map
#Consider switching to Gompertz if we need to implement a lag phase

# changed all 'otherwise = NULL' to 'otherwise = 0' Ask Doug if ok.
#Something changed, now throwing error 
# Warning: Problem with `mutate()` column `OD720_logistic`.
# ℹ `OD720_logistic = map(...)`.
# ℹ lmdif: info = 0. Improper input parameters.

ProcessDataNestGrowth  <- ProcessData %>%
nest(tubedata = c(time, abs_time, ToD, Day, Actinic_par, OD680, OD720, deltaOD, ActinicMid_parOD720, ActinicMid_dayOD720)) %>%
  mutate(OD720_logistic = map(tubedata, possibly(~nlsLM(OD720 ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x,
                            #start = list(pmax = max(.$OD720, na.rm = TRUE), mu = 0.010, intercept = min(.$OD720, na.rm = TRUE)),
                            start = list(pmax = max(.$OD720, na.rm = TRUE),  mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), intercept = min(.$OD720, na.rm = TRUE)),
                            #lower = c(pmax = max(.$OD720, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                            lower = c(max(.$OD720, na.rm = TRUE)/2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.1, min(.$OD720, na.rm = TRUE) * 0.1),
                            #upper = c(pmax = max(.$OD720, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                            upper = c(max(.$OD720, na.rm = TRUE)*2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, min(.$OD720, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         OD720trunc_logistic = map(tubedata, possibly(~nlsLM(OD720 ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x %>%
                              filter(OD720 <= max(OD720) * TruncFactor), 
                            #start = list(pmax = max(.$OD720, na.rm = TRUE), mu = 0.010, intercept = min(.$OD720, na.rm = TRUE)),
                            start = list(pmax = max(.$OD720, na.rm = TRUE),  mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), intercept = min(.$OD720, na.rm = TRUE)),
                            #lower = c(pmax = max(.$OD720, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                            lower = c(0, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$OD720, na.rm = TRUE) * 0.01),
                            #upper = c(pmax = max(.$OD720, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                            upper = c(48, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$OD720, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         OD720trunc_exp = map(tubedata, possibly(~nlsLM(OD720 ~ exp_eqn(x = time, mu, intercept),
                            data = .x %>%
                              filter(OD720 <= max(OD720) * TruncFactor), 
                          start = list(mu = 0.015, intercept = min(.$OD720, na.rm = TRUE)),
                          lower = c(mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                          upper = c(mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                          control = list(maxiter = 500)), otherwise = NULL)),
         OD720_logistic_tidied =  map(OD720_logistic, possibly(tidy, otherwise = NULL)),
         OD720_logistic_param = map(OD720_logistic,possibly(glance, otherwise = NULL)),
         OD720trunc_logistic_tidied =  map(OD720trunc_logistic, possibly(tidy, otherwise = NULL)),
         OD720trunc_logistic_param = map(OD720trunc_logistic,possibly(glance, otherwise = NULL)),
         OD720trunc_exp_tidied =  map(OD720trunc_exp, possibly(tidy, otherwise = NULL)),
         OD720trunc_exp_param = map(OD720trunc_exp,possibly(glance, otherwise = NULL)),
         ) %>%
  mutate(deltaOD_logistic = map(tubedata, possibly(~nlsLM(deltaOD ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x,
                            #start = list(pmax = max(.$deltaOD, na.rm = TRUE), mu = 0.010, intercept = min(.$deltaOD, na.rm = TRUE)),
                            start = list(pmax = max(.$deltaOD, na.rm = TRUE),  mu = (log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm =                                              TRUE)))/max(.$time), intercept = min(.$deltaOD, na.rm = TRUE)),
                            #lower = c(pmax = max(.$deltaOD, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$deltaOD, na.rm = TRUE)),
                            lower = c(0, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$deltaOD, na.rm = TRUE) * 0.01),
                          #upper = c(pmax = max(.$deltaOD, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$deltaOD, na.rm = TRUE)),
                           upper = c(48, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$deltaOD, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         deltaOD_logistic_tidied =  map(deltaOD_logistic, possibly(tidy, otherwise = NULL)),
         deltaOD_logistic_param = map(deltaOD_logistic,possibly(glance, otherwise = NULL)),
         ) %>%
         # ,
         # GrowthFlag_OD720 = if_else(OD720_logistic != "NULL", 1, 0),
         # GrowthFlag_deltaOD = if_else(deltaOD_logistic != "NULL", 1, 0))

  
 
  mutate(OD720_FitGompertz = map(tubedata, possibly(~nlsLM(OD720 ~ ModGompertzEqn(x = time, lag, pmax, mu),
                                    data = .x,
                                    start = list(lag = 0, mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), pmax = max(.$OD720, na.rm = TRUE)),
                                    lower = c(max(.$OD720, na.rm = TRUE)/2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$OD720, na.rm = TRUE) * 0.01),
                                    upper = c(max(.$OD720, na.rm = TRUE)*2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$OD720, na.rm = TRUE) * 1.5),
                                   control = list(maxiter = 500)), otherwise = NULL)),
         OD720_FitGompertz_tidied =  map(OD720_FitGompertz, possibly(tidy, otherwise = NULL)),
         OD720_FitGompertz_param = map(OD720_FitGompertz,possibly(glance, otherwise = NULL)),
  ) %>%
mutate(deltaOD_FitGompertz = map(tubedata, possibly(~nlsLM(deltaOD ~ ModGompertzEqn(x = time, lag, pmax, mu),
                                    data = .x,
                                    start = list(lag = 0, mu = (log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time), pmax = max(.$deltaOD, na.rm = TRUE)),
                                    lower = c(max(.$deltaOD, na.rm = TRUE)/2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$deltaOD, na.rm = TRUE) * 0.01),
                                    upper = c(max(.$deltaOD, na.rm = TRUE)*2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$deltaOD, na.rm = TRUE) * 1.5),
                                   control = list(maxiter = 500)), otherwise = NULL)),
       deltaOD_FitGompertz_tidied =  map(deltaOD_FitGompertz, possibly(tidy, otherwise = NULL)),
         deltaOD_FitGompertz_param = map(deltaOD_FitGompertz,possibly(glance, otherwise = NULL)),
       )



#if OD720_logistic fit fails, drop that row
# ProcessDataNestGrowth <- ProcessDataNestGrowth %>%
#   drop_na(OD720_logistic)

#better to put the drop_na(OD720_logistic) in before plots so 'NULL' results are not lost from saved data

```

```{r test nested logistic regressions }
# ProcessDataReset <- ProcessData %>%
#   group_by(Tube) %>%
#   mutate(Time = time - time[1]) %>%
#   ungroup()

# FitDataLag <- FitData %>%
#   group_by(!!sym(NestVar), !!sym(RowVar2), !!sym(RowVar), !!sym(ColVar), Wavelength, exp_date) %>%
#   mutate(LagSeed = E_hours[which.min(CorrOD)])

#Use Tube Specific Starting values in map
#Consider switching to Gompertz if we need to implement a lag phase

# changed all 'otherwise = NULL' to 'otherwise = 0' Ask Doug if ok.
#Something changed, now throwing error 
# Warning: Problem with `mutate()` column `OD720_logistic`.
# ℹ `OD720_logistic = map(...)`.
# ℹ lmdif: info = 0. Improper input parameters.

TestProcessDataNestGrowth  <- ProcessData %>%
nest(tubedata = c(time, abs_time, ToD, Day, Actinic_par, OD680, OD720, deltaOD, ActinicMid_parOD720, ActinicMid_dayOD720)) %>%
  mutate(OD720_logistic = map(tubedata, possibly(~nlsLM(OD720 ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x,
                            #start = list(pmax = max(.$OD720, na.rm = TRUE), mu = 0.010, intercept = min(.$OD720, na.rm = TRUE)),
                            start = list(pmax = max(.$OD720, na.rm = TRUE),  mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), intercept = min(.$OD720, na.rm = TRUE)),
                            #lower = c(pmax = max(.$OD720, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                            lower = c(max(.$OD720, na.rm = TRUE)/2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.01, min(.$OD720, na.rm = TRUE) * 0.01),
                            #upper = c(pmax = max(.$OD720, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                            upper = c(max(.$OD720, na.rm = TRUE)*2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, min(.$OD720, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         OD720trunc_logistic = map(tubedata, possibly(~nlsLM(OD720 ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x %>%
                              filter(OD720 <= max(OD720) * TruncFactor), 
                            #start = list(pmax = max(.$OD720, na.rm = TRUE), mu = 0.010, intercept = min(.$OD720, na.rm = TRUE)),
                            start = list(pmax = max(.$OD720, na.rm = TRUE),  mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), intercept = min(.$OD720, na.rm = TRUE)),
                            #lower = c(pmax = max(.$OD720, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                            lower = c(max(.$OD720, na.rm = TRUE)/2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$OD720, na.rm = TRUE) * 0.01),
                            #upper = c(pmax = max(.$OD720, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                            upper = c(max(.$OD720, na.rm = TRUE)*2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$OD720, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         OD720trunc_exp = map(tubedata, possibly(~nlsLM(OD720 ~ exp_eqn(x = time, mu, intercept),
                            data = .x %>%
                              filter(OD720 <= max(OD720) * TruncFactor), 
                          start = list(mu = 0.015, intercept = min(.$OD720, na.rm = TRUE)),
                          lower = c(mu = 0.0, intercept = min(.$OD720, na.rm = TRUE)),
                          upper = c(mu = 0.5, intercept = max(.$OD720, na.rm = TRUE)),
                          control = list(maxiter = 500)), otherwise = NULL)),
         OD720_logistic_tidied =  map(OD720_logistic, possibly(tidy, otherwise = NULL)),
         OD720_logistic_param = map(OD720_logistic,possibly(glance, otherwise = NULL)),
         OD720trunc_logistic_tidied =  map(OD720trunc_logistic, possibly(tidy, otherwise = NULL)),
         OD720trunc_logistic_param = map(OD720trunc_logistic,possibly(glance, otherwise = NULL)),
         OD720trunc_exp_tidied =  map(OD720trunc_exp, possibly(tidy, otherwise = NULL)),
         OD720trunc_exp_param = map(OD720trunc_exp,possibly(glance, otherwise = NULL)),
         ) %>%
  mutate(deltaOD_logistic = map(tubedata, possibly(~nlsLM(deltaOD ~ logistic_eqn(x = time, pmax, mu, intercept),
                            data = .x,
                            #start = list(pmax = max(.$deltaOD, na.rm = TRUE), mu = 0.010, intercept = min(.$deltaOD, na.rm = TRUE)),
                            start = list(pmax = max(.$deltaOD, na.rm = TRUE),  mu = (log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm =                                              TRUE)))/max(.$time), intercept = min(.$deltaOD, na.rm = TRUE)),
                            #lower = c(pmax = max(.$deltaOD, na.rm = TRUE)/2, mu = 0.0, intercept = min(.$deltaOD, na.rm = TRUE)),
                            lower = c(max(.$deltaOD, na.rm = TRUE)/2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$deltaOD, na.rm = TRUE) * 0.01),
                          #upper = c(pmax = max(.$deltaOD, na.rm = TRUE)*10, mu = 0.5, intercept = max(.$deltaOD, na.rm = TRUE)),
                           upper = c(max(.$deltaOD, na.rm = TRUE)*2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$deltaOD, na.rm = TRUE) * 1.5),
                            control = list(maxiter = 500)), otherwise = NULL)),
         deltaOD_logistic_tidied =  map(deltaOD_logistic, possibly(tidy, otherwise = NULL)),
         deltaOD_logistic_param = map(deltaOD_logistic,possibly(glance, otherwise = NULL)),
         ) %>%
         # ,
         # GrowthFlag_OD720 = if_else(OD720_logistic != "NULL", 1, 0),
         # GrowthFlag_deltaOD = if_else(deltaOD_logistic != "NULL", 1, 0))

  
 
 mutate(OD720_FitGompertz = map(tubedata, possibly(~nlsLM(OD720 ~ ModGompertzEqn(x = time, lag, pmax, mu),
                                    data = .x,
                                    start = list(lag = 0, mu = (log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time), pmax = max(.$OD720, na.rm = TRUE)),
                                    lower = c(max(.$OD720, na.rm = TRUE)/2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$OD720, na.rm = TRUE) * 0.01),
                                    upper = c(max(.$OD720, na.rm = TRUE)*2, ((log(max(.$OD720, na.rm = TRUE)) - log(min(.$OD720, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$OD720, na.rm = TRUE) * 1.5),
                                   control = list(maxiter = 500)), otherwise = NULL)),
         OD720_FitGompertz_tidied =  map(OD720_FitGompertz, possibly(tidy, otherwise = NULL)),
         OD720_FitGompertz_param = map(OD720_FitGompertz,possibly(glance, otherwise = NULL)),
  ) %>%
mutate(deltaOD_FitGompertz = map(tubedata, possibly(~nlsLM(deltaOD ~ ModGompertzEqn(x = time, lag, pmax, mu),
                                    data = .x,
                                    start = list(lag = 0, mu = (log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time), pmax = max(.$deltaOD, na.rm = TRUE)),
                                    lower = c(max(.$deltaOD, na.rm = TRUE)/2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 0.01, max(.$deltaOD, na.rm = TRUE) * 0.01),
                                    upper = c(max(.$deltaOD, na.rm = TRUE)*2, ((log(max(.$deltaOD, na.rm = TRUE)) - log(min(.$deltaOD, na.rm = TRUE)))/max(.$time)) * 1.5, max(.$deltaOD, na.rm = TRUE) * 1.5),
                                   control = list(maxiter = 500)), otherwise = NULL)),
       deltaOD_FitGompertz_tidied =  map(deltaOD_FitGompertz, possibly(tidy, otherwise = NULL)),
         deltaOD_FitGompertz_param = map(deltaOD_FitGompertz,possibly(glance, otherwise = NULL)),
       )



#if OD720_logistic fit fails, drop that row
# ProcessDataNestGrowth <- ProcessDataNestGrowth %>%
#   drop_na(OD720_logistic)

#better to put the drop_na(OD720_logistic) in before plots so 'NULL' results are not lost from saved data
```


```{r plot logistics predictions}
#improve with automated annotate placement based upon data traces; difficulty is that data is nested until expansion for ggplot b/c we need to conserve memory so data traces are not easily accessible
# segmentYstart <- as.numeric(IntervalDataTube1[IntervalDataTube1$time == 52, "lnOD680"])
# segmentYend <- as.numeric(IntervalDataTube1[IntervalDataTube1$time == 54, "lnOD680"])

OD_x = 150
OD_y = 0.15

Par_x = 350
Par_y = 0.04

Resid_x = 80
Resid_y = -0.03

Predict_x = 90
Predict_y = 0.06

#predictions of condition specific fits
OD720LogGrowthPlot <- TestProcessDataNestGrowth %>%
  #drop_na(OD720_logistic) %>%
  mutate(OD720_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, OD720_logistic_predict),names_sep = "_", keep_empty = TRUE) %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
 # geom_text(data = . %>% filter(GrowthFlag_OD720 == 0), aes(x = 200, y = 0.2, label = "*"), size = 5) +
  geom_point(aes(x = tubedata_time, y = OD720_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = OD720_logistic_predict_.resid), colour = "red", size = 0.05) +geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720LogGrowthPlot



OD720LogGrowthPlotExpand <- TestProcessDataNestGrowth %>%
  #drop_na(OD720_logistic) %>%
  filter(Tube == 1) %>%
  mutate(OD720_logistic_predict = map(OD720_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, OD720_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = tubedata_time, y = OD720_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = OD720_logistic_predict_.resid), colour = "red", size = 0.05) + 
  geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.1, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  annotate(geom = "text", x = OD_x, y = OD_y, label = "OD720", size = 5, colour = "darkgreen") +
  annotate(geom = "text", x = Par_x, y = Par_y, label = "Light level", size = 5, colour = "darkblue") +
  annotate(geom = "text", x = Resid_x, y = Resid_y, label = "Model residuals", size = 5, colour = "red") +
  annotate(geom = "text", x = Predict_x, y = Predict_y, label = "Logistic Regression", size = 5, colour = "black") +
  #7_cartesian(xlim = c(-5, 255)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720LogGrowthPlotExpand

DeltaODLogGrowthPlot <- TestProcessDataNestGrowth %>%
  #drop_na(deltaOD_logistic) %>%
  mutate(deltaOD_logistic_predict = map(deltaOD_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, deltaOD_logistic_predict),names_sep = "_", keep_empty = TRUE) %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_deltaOD), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  #geom_text(data = . %>% filter(GrowthFlag_deltaOD == 0), aes(x = 200, y = 0.2, label = "*"), size = 5) +
  geom_point(aes(x = tubedata_time, y = deltaOD_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = deltaOD_logistic_predict_.resid), colour = "red", size = 0.05) + geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Delta Optical Density (deltaOD)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

DeltaODLogGrowthPlot

DeltaODLogGrowthPlotExpand <- TestProcessDataNestGrowth %>%
  #drop_na(deltaOD_logistic) %>%
  filter(Tube == 1) %>%
  mutate(deltaOD_logistic_predict = map(deltaOD_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, deltaOD_logistic_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_deltaOD), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = tubedata_time, y = deltaOD_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = deltaOD_logistic_predict_.resid), colour = "red", size = 0.05) + 
  geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.5, alpha = 0.1) +
  #coord_cartesian(xlim = c(0, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  annotate(geom = "text", x = OD_x, y = OD_y, label = "deltaOD", size = 5, colour = "darkgreen") +
  annotate(geom = "text", x = Par_x, y = Par_y, label = "Light level", size = 5, colour = "darkblue") +
  annotate(geom = "text", x = Resid_x, y = Resid_y, label = "Model residuals", size = 5, colour = "red") +
  annotate(geom = "text", x = Predict_x, y = Predict_y, label = "Logistic Regression", size = 5, colour = "black") +
  labs(subtitle = "Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName , y = "Delta Optical Density (deltaOD)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

DeltaODLogGrowthPlotExpand



OD720truncLogGrowthPlot <- TestProcessDataNestGrowth %>%
  #drop_na(OD720trunc_logistic) %>%
  #filter(Tube == 1) %>%
  mutate(OD720trunc_logistic_predict = map(OD720trunc_logistic, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(OD720trunc_logistic_predict), names_sep = "_", keep_empty = TRUE) %>%
  ggplot() +
  geom_point(aes(x = OD720trunc_logistic_predict_time, y = OD720trunc_logistic_predict_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
 # geom_text(data = . %>% filter(GrowthFlag_OD720 == 0), aes(x = 200, y = 0.2, label = "*"), size = 5) +
  geom_point(aes(x = OD720trunc_logistic_predict_time, y = OD720trunc_logistic_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = OD720trunc_logistic_predict_time, y = OD720trunc_logistic_predict_.resid), colour = "red", size = 0.05) + #geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  labs(subtitle = "Truncated- Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720truncLogGrowthPlot

OD720GompertzLogGrowthPlot <- TestProcessDataNestGrowth %>%
  #drop_na(OD720_FitGompertz) %>%
  mutate(OD720_FitGompertz_predict = map(OD720_FitGompertz, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, OD720_FitGompertz_predict),names_sep = "_", keep_empty = TRUE) %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = tubedata_time, y = OD720_FitGompertz_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = OD720_FitGompertz_predict_.resid), colour = "red", size = 0.05) +geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  labs(subtitle = "Gompertz Fit OD720;Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720GompertzLogGrowthPlot

OD720GompertzLogGrowthPlotExpand <- TestProcessDataNestGrowth %>%
  #drop_na(OD720_FitGompertz) %>%
  filter(Tube == 1) %>%
  mutate(OD720_FitGompertz_predict = map(OD720_FitGompertz, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, OD720_FitGompertz_predict),names_sep = "_") %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_OD720), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = tubedata_time, y = OD720_FitGompertz_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = OD720_FitGompertz_predict_.resid), colour = "red", size = 0.05) + 
  geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.1, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  annotate(geom = "text", x = OD_x, y = OD_y, label = "OD720", size = 5, colour = "darkgreen") +
  annotate(geom = "text", x = Par_x, y = Par_y, label = "Light level", size = 5, colour = "darkblue") +
  annotate(geom = "text", x = Resid_x, y = Resid_y, label = "Model residuals", size = 5, colour = "red") +
  annotate(geom = "text", x = Predict_x, y = Predict_y, label = "Logistic Regression", size = 5, colour = "black") +
  #7_cartesian(xlim = c(-5, 255)) +
  labs(subtitle = "Gompertz Fit OD720; Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (OD720)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

OD720GompertzLogGrowthPlotExpand

deltaODGompertzLogGrowthPlot <- TestProcessDataNestGrowth %>%
  #drop_na(deltaOD_FitGompertz) %>%
  mutate(deltaOD_FitGompertz_predict = map(deltaOD_FitGompertz, possibly(augment, otherwise = NULL))) %>%
  unnest(cols = c(tubedata, deltaOD_FitGompertz_predict),names_sep = "_", keep_empty = TRUE) %>%
  ggplot() +
  geom_point(aes(x = tubedata_time, y = tubedata_deltaOD), colour = "darkgreen", size = 0.1) +
  scale_colour_manual(values = MCMIXColours) +
  geom_point(aes(x = tubedata_time, y = deltaOD_FitGompertz_predict_.fitted), colour = "black", size = 0.1) +
  geom_point(aes(x = tubedata_time, y = deltaOD_FitGompertz_predict_.resid), colour = "red", size = 0.05) +geom_point(aes(x = tubedata_time, y = tubedata_Actinic_par/1000, colour = as.factor(WL)), size = 0.05, alpha = 0.1) +
  #coord_cartesian(xlim = c(-5, 675)) +
  #scale_x_continuous(breaks=seq(0, 675, by = 125)) +
  facet_grid(rows = vars(O2), cols = vars(Tube, WL, Par_ue, Strain, Photoperiod)) +
  labs(subtitle = "Gompertz Fit deltaOD;Tube; Growth Light (nm; µE); Strain; Photoperiod", caption = ProcessFileName, y = "Optical Density 720nm (deltaOD)", x = "Elapsed Time (h)") +
  theme_bw() +
  labs(colour = "Actinic PAR (nm)")

deltaODGompertzLogGrowthPlot




```

```{r save logistic model plots}
ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "OD720LogGrowthPlot",".png",sep = "")), plot = OD720LogGrowthPlot, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "OD720LogGrowthPlotExpand",".png",sep = "")), plot = OD720LogGrowthPlotExpand, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "DeltaODLogGrowthPlot",".png",sep = "")), plot = DeltaODLogGrowthPlot, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsPath, paste(ProcessFileName, "DeltaODLogGrowthPlotExpand",".png",sep = "")), plot = DeltaODLogGrowthPlotExpand, device = NULL, scale = 1, height=10, width= 20, units = c("cm"),dpi = 300, limitsize = TRUE)

```

```{r exlude poor fits}
# TestProcessDataNestGrowth %>%
#   filter(Tube != 4
```


```{r logistic fit terms}
# GrowthFlagError defined at start
kable(ProcessDataNestGrowth %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_")  %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
  mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se) < ((OD720_pmax - OD720_pmax_se) & (OD720_mu_se < OD720_mu * GrowthFlagError) & (OD720_pmax_se < OD720_pmax * GrowthFlagError) ), 1, 0)))



```

Plot Logistic Fit Terms vs. conditions
```{r logistic fit terms}
ProcessDataNestGrowth %>%
 drop_na(OD720_logistic) %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
 #mutate(GrowthFlag_OD720 = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se) | (OD720_pmax != "NULL"), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_mu, colour = as.factor(WL))) +
  #geom_text(data = . %>% filter(GrowthFlag_OD720 == 0), aes(x = Par_ue, y = 0, label = "*")) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_mu - OD720_mu_se, ymax = OD720_mu + OD720_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 drop_na(deltaOD_logistic) %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
#mutate(GrowthFlag_deltaOD = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se) | (deltaOD_pmax != "NULL"), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_mu, colour = as.factor(WL))) +
  #geom_text(data = . %>% filter(GrowthFlag_deltaOD == 0), aes(x = Par_ue, y = 0, label = "*")) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_mu - deltaOD_mu_se, ymax = deltaOD_mu + deltaOD_mu_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 drop_na(OD720_logistic) %>%
 unnest(cols = c(OD720_logistic_tidied),names_sep = "_") %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, OD720_logistic_tidied_term, OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  OD720_logistic_tidied_term, values_from = c(OD720_logistic_tidied_estimate, OD720_logistic_tidied_std.error), names_sep = "_") %>%
  rename(OD720_pmax = OD720_logistic_tidied_estimate_pmax,
         OD720_pmax_se = OD720_logistic_tidied_std.error_pmax,
         OD720_mu = OD720_logistic_tidied_estimate_mu,
         OD720_mu_se = OD720_logistic_tidied_std.error_mu,
         OD720_intercept = OD720_logistic_tidied_estimate_intercept,
         OD720_intercept_se = OD720_logistic_tidied_std.error_intercept) %>%
#mutate(GrowthFlag = if_else((OD720_intercept + OD720_intercept_se)  < (OD720_pmax - OD720_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = OD720_pmax, colour = as.factor(WL))) +
  #geom_text(data = . %>% filter(GrowthFlag_OD720 == 0), aes(x = Par_ue, y = 0, label = "*")) +
  geom_errorbar(aes(x = Par_ue, ymin = OD720_pmax - OD720_pmax_se, ymax = OD720_pmax + OD720_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

ProcessDataNestGrowth %>%
 drop_na(deltaOD_logistic) %>%
 unnest(cols = c(deltaOD_logistic_tidied),names_sep = "_", keep_empty = TRUE) %>%
  select(c(Filename, Tube, Strain, Par_ue, Photoperiod, Temp_c, O2, WL, LightShape, deltaOD_logistic_tidied_term, deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error)) %>%
  pivot_wider(names_from =  deltaOD_logistic_tidied_term, values_from = c(deltaOD_logistic_tidied_estimate, deltaOD_logistic_tidied_std.error), names_sep = "_") %>%
  rename(deltaOD_pmax = deltaOD_logistic_tidied_estimate_pmax,
         deltaOD_pmax_se = deltaOD_logistic_tidied_std.error_pmax,
         deltaOD_mu = deltaOD_logistic_tidied_estimate_mu,
         deltaOD_mu_se = deltaOD_logistic_tidied_std.error_mu,
         deltaOD_intercept = deltaOD_logistic_tidied_estimate_intercept,
         deltaOD_intercept_se = deltaOD_logistic_tidied_std.error_intercept) %>%
 #mutate(GrowthFlag = if_else((deltaOD_intercept + deltaOD_intercept_se)  < (deltaOD_pmax - deltaOD_pmax_se), 1, 0)) %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_pmax, colour = as.factor(WL))) +
  #geom_text(data = . %>% filter(GrowthFlag_deltaOD == 0), aes(x = Par_ue, y = 0, label = "*")) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_pmax - deltaOD_pmax_se, ymax = deltaOD_pmax + deltaOD_pmax_se, colour = as.factor(WL))) + 
  scale_colour_manual(values = MCMIXColours) +
  facet_grid (cols = vars(Strain), rows = vars(O2)) +
  theme_bw()

```




# Save .Rds of ProcessDataNestGrowth containing logistic fits of growth data from time resolved and whole interval fits

```{r}
saveRDS(object = ProcessDataNestGrowth, file = file.path(DataOut, paste(ProcessFileName,  "ProcessDataNestGrowth.Rds",  sep = "_")), ascii = FALSE, version = NULL, compress = TRUE, refhook = NULL)


```
