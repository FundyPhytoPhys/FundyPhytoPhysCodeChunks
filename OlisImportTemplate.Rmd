---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sarah Gore, Adrian Kryk"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer

```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(googledrive)
library(googlesheets4)
library(broom)
```

```{r set project variables}
Project <- "Pico"
DataPath <- "OLISSpectra"
OutPath <- "OLISProcess"

```

```{r set colours}
Wavelengths_nm = c("WW", 470, 530, 660)

Colours_nm = c("black", "dodgerblue", "darkgreen", "red")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```


```{r list available OLIS Files}
OLISDates <- list.files(path = file.path("..", DataPath, fsep = .Platform$file.sep),  full.names = TRUE, recursive = "False")
#recursive = "False" only lists files or folders at top level of target folder

OLISDates

OLISFiles <- list.files(path = file.path("..", DataPath, fsep = .Platform$file.sep), pattern = ".asc", full.names = TRUE, recursive = "True")
#recursive = "True" lists all files within sub-folders
#pattern = ".asc" only lists .asc files exported from OLIS, not 'internal' .ols files

OLISFiles
```

For SySl files 'baseline' in filename means baseline spectra already subtracted within OLIS software.
This was not universallly true across all projects; be careful.
For SySl files 'raw' means spectra of undiluted culture; other spectra are 1 ml culture + 8 ml media.


Currently: read and 'tidy' all files from a single capture date, separate from all other dates?

Ideally: we want to read and tidy some user-selected set of files taken from multiple dates?

# set up read_delim_plus
```{r}
# #make this more robust to variable file formats
FileEncode <- "UTF-8"
Delimiter <- " "
# #.asc files from export from OLIS seem to use spaces as delimiter
# 
HeaderRows <- 0

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = FALSE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
  }
```

# Import and concatenate OLISSpectra files from a user-selected date
```{r import files from specific OLISDate folder}
# OLISDate <- "20211207"
# #OLISDates <- c("20211207", "20220104")
# 
# #make this more robust to variable file formats
# FileEncode <- "UTF-8" 
# Delimiter <- " "
# #.asc files from export from OLIS seem to use spaces as delimiter
# 
# HeaderRows <- 0
# 
# OLISDateFiles <- list.files(path = file.path("..", DataPath, OLISDate, fsep = .Platform$file.sep), pattern = ".asc", full.names = TRUE, recursive = "False")
# 
# #pattern = ".asc" only lists .asc files, not .ols files
# 
# #Baseline <- OlisDateFiles[length(OlisDateFiles)]
# #not sure what this would do?
# 
# read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = FALSE, row.names = NULL) %>%
#     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
# }
# 
# OLISDateSpectra <- OLISDateFiles %>% 
#   map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>%
#   separate(col = V1, into = c("nm", "Abs"), sep = "	") %>%
#   mutate(nm = as.numeric(nm),
#          Abs = as.numeric(Abs))
#          
# OLISDateSpectra <- OLISDateSpectra %>%
#   mutate(SampleID = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_"),
#          SampleID = str_remove_all(SampleID, "_"))
# #assumes that SampleID follows Campbell Lab format of AaBb1111 and that file name contains _SampleID_ in the format AaBb1234
#   
#   #  mutate(Baseline = if_else(str_detect(Filename, "baseline"), 1, 0))
#          
# OLISDateSpectra <- OLISDateSpectra %>%
#   mutate(FileDateTime = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
#          FileDateTime = str_remove_all(FileDateTime, "_"),
#          FileDateTime = str_remove_all(FileDateTime, "/"),
#          FileDateTime = ymd_hm(FileDateTime)
#   )

```


Preliminary plot of OLISDateSpectra (reality therapy)
```{r prelimplot}
# OLISDateSpectra %>% ggplot() +
#   geom_point(aes(x = nm, y = Abs, colour = Filename), size = 0.1) +
#   theme_bw()

#if this chunk throws 'errors' or 'messages' it suggests problems with the data
```

# Import and concatenate all files from OLISSpectra
```{r import all .asc files from OLISSpectra folder}
#This chunk runs slowly.  Be sure all files are saved to local harddrive (force DropBox 'smartsync' to 'Local'
#The resulting data object is large depending upon the number of files included

#not yet sure how to import data from selected sub-set of date folders.
#One approach would be a double map approach; capture the character vector of desired sub-folders, then feed that to preceding map function.

# OLISFiles <- list.files(path = file.path("..", DataPath, OLISDate, fsep = .Platform$file.sep), pattern = ".asc", full.names = TRUE, recursive = "TRUE")

#pattern = ".asc" only lists .asc files, not .ols files

OLISSpectra <- OLISFiles %>% 
  map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows))

OLISSpectra <- OLISSpectra %>%
  separate(col = V1, into = c("nm", "Abs"), sep = "	") %>%
  mutate(nm = as.numeric(nm),
         Abs = as.numeric(Abs)) %>%
  mutate(SampleID = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_"),
         SampleID = str_remove_all(SampleID, "_"))
#assumes that SampleID follows Campbell Lab format of AaBb1111 and that file name contains _SampleID_ in the format AaBb1234
  
  #  mutate(Baseline = if_else(str_detect(Filename, "baseline"), 1, 0))
         
OLISSpectra <- OLISSpectra %>%
  mutate(FileDateTime = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         FileDateTime = str_remove_all(FileDateTime, "_"),
         FileDateTime = str_remove_all(FileDateTime, "/"),
         FileDateTime = ymd_hm(FileDateTime)
  )

OLISSpectra[1:10,]
```

# Clean up imported files to remove rows where SampleID or FileDateTime failed
```{r OLISSpectra cleanup}

OLISSpectra <- OLISSpectra %>%
  filter(!is.na(SampleID),
         !is.na(FileDateTime))
```


```{r load MetaData direct from googlesheet}
gs4_deauth()
#deauthorizes access to googlesheet
#requires googlesheet setting 'Share = Anyone with link'

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0")

#read_sheet occasionally glitches, particularly if the same googlesheet has been read multiple times in succession

#implement read with googlesheet name instead of full url
# MetaData <- drive_get(paste(Project, "Catalog", sep = ""))

```

```{r load local MetaData, message = FALSE, warning = FALSE}
#name directory with culture catalog
#avoid hard file paths; use only relative
#set current 'Project' name; use for later saving to process_data
#make more complex to cope with saving of data subsets later

# MetaData<- read_csv(paste(Project, "Catalog" ,".csv", sep = ""))

```

# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- left_join(x = OLISSpectra, y = MetaData, by = c("SampleID" = "ID"))

rm(MetaData)
rm(OLISDateSpectra)
rm(OLISSpectra)
#remove large MetaData dataframe to lower memory overhead
```

# Clean up unneeded columns and rows from OLISSpectraMeta to save memory
# Many rows fail on 'Strain', possible problem?
```{r Clean up OLISSpectraMeta}

#https://community.rstudio.com/t/drop-all-na-columns-from-a-dataframe/5844/3
not_all_na <- function(x) {!all(is.na(x))}

OLISSpectraMeta <- OLISSpectraMeta %>%
  select_if(not_all_na) %>%
  filter(!is.na(Strain))
```


# Preliminary plots of OLISSpectra
Fix colour value for WhiteLight to WW in MetaData GoogleSheet
Doug set plot colours to match spectral values
```{r strain plot}

Xvar = sym("nm")
Yvar = sym("Abs")

Groupvar1 = sym("Filename")
Groupvar2 = sym("WL")
Groupvar3 = sym("Strain")
Groupvar4 = sym("Par_ue")
Groupvar5 = sym("Photoperiod")
TargetStrain = sym("BA127R")
TargetWL = sym("WL")

# Colourvar = sym("pH")
# Rowvar = sym("par_ue")
# Colvar = sym("alkalinity")
# Filtervar = sym("par_ue")

#https://stackoverflow.com/questions/11353287/how-do-you-add-a-general-label-to-facets-in-ggplot2

OLISSpectraMeta %>% 
  #filter(WL != "WL") %>%
  filter(Strain %in% c("BA60G","BA77G","BA132R","BA48G","BA127R")) %>%
  filter(Par_ue %in% c(30, 180)) %>%
  ggplot() +
  geom_point(aes(x = !!Xvar, y = !!Yvar), size = 0.1) +
  facet_grid(rows = vars(!!Groupvar3), cols = vars(!!Groupvar4)) +
  theme_bw() +
  coord_cartesian(ylim = c(0, 1.5)) + 
  scale_y_continuous(sec.axis = sec_axis(~ . , name = Groupvar3, breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = Groupvar4, breaks = NULL, labels = NULL))

#, colour = as.factor(!!Groupvar2)
#labels(caption = paste(nm, "nm; PAR", par, "uE"))
#filter(!!filtervar %in% c(0,32,35)) %>%

# scale_colour_manual(values = Colours_nm) +
   
OLISSpectraMeta %>% 
  #filter(WL != "WL") %>%
  #filter(WL == TargetWL) %>%
  filter(Strain == TargetStrain) %>%
  filter(Par_ue %in% c(30, 180)) %>%
  ggplot() +
  geom_point(aes(x = !!Xvar, y = !!Yvar), size = 0.1) +
  facet_grid(rows = vars(!!Groupvar5), cols = vars(!!Groupvar4, as.factor(!!Groupvar2))) +
  theme_bw() +
  coord_cartesian(ylim = c(0, 1.5)) + 
  scale_y_continuous(sec.axis = sec_axis(~ . , name = Groupvar5, breaks = NULL, labels = NULL)) +
  scale_x_continuous(sec.axis = sec_axis(~ . , name = paste(Groupvar4, Groupvar2), breaks = NULL, labels = NULL)) +
  labs(title = TargetStrain)

```
# Save assembled spectra data set
```{r save Olis}
saveRDS(OLISSpectraMeta, file = file.path("..", "OLISProcess", "OLISSpectraMeta.rds"))
```

6 Jan 10:19
What does Sylwia want to do with these spectra?

i) Check changes in pigment peak heights across growth conditions within a strain
ii) How do pigments change over growth trajectory within a strain
iii) Check OLIS spectra correlated with calculated pigment contents; Yes

iv) Evaluate pigment content per cell and per ml (with cell counts)

So: Will need to extract values for particular absorbance peaks
Possibly: Deconvolute absorbance peaks into separate contributions from multiple different pigments  (Need to find appropriate package(s) for this)

Need to implement plots overlaying spectra from the same strain under different growth conditions.
Need to implement plots overlaying spectra from the same strain at different growth points

Think about matrix plot with perhaps strain, Par_ue, WL, photoperiod, growth stage as 'visual grammar'

Find code from light attenuation work to show rainbow colour gradient 'rug' along bottom.

```{r oldcode, warning=FALSE, message=FALSE}

# base <- olis_spectra %>%
#   filter(filename == baseline)
# 
# olis_spectra$base <- base$Abs
# 
# olis_spectra <- olis_spectra %>% 
#   mutate(CorrAbs = Abs - base)
# 
# olis_spectra <- olis_spectra %>%
#   group_by(filename) %>%
#   mutate(AbsNorm750 = (CorrAbs/CorrAbs[length(CorrAbs)]),
#          Abs750_0 = (CorrAbs - CorrAbs[length(CorrAbs)])) %>%
#   ungroup()
```



```{r save spectra plots}
# ggsave(filename = file.path("plots", paste(project, 
# str_c(strains, collapse = "_"), str_c(startdate, collapse = "_"),"olis_plot.png", sep = "_"),fsep = .Platform$file.sep ), plot = olis_plot)
```

```{r second derivative}
#https://stackoverflow.com/questions/49762128/rolling-regression-by-group-in-the-tidyverse?noredirect=1&lq=1

#function to generate slope from ratio of covariance to variance
# slope <- . %>% { cov(.[, 2], .[, 1]) / var(.[, 2])}
# 
# #range rolling window variables; be careful with different data sets
# NmperRow <- ((base$nm[length(base$nm)]- base$nm[1]) +1)/nrow(base)
# FirstRange <- 6
# SecondRange <- 6
#             
# olis_spectra <- olis_spectra %>%
#   group_by(filename) %>%
#   mutate(FirstDeriv = rollapplyr(cbind(Abs750_0, nm), FirstRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
#     mutate(SecondDeriv = rollapplyr(cbind(FirstDeriv, nm), SecondRange, slope, by.column = FALSE, align = 'right', fill = NA)) %>%
#     ungroup()
# 
# #different approach
# olis_spectra <- olis_spectra %>%
#   group_by(filename) %>%
#   mutate(diffnm = nm - lag(nm, n =  FirstRange),
#          diffAbs750_0 = Abs750_0 - lag(Abs750_0, n = FirstRange),
#          dAdnm = diffAbs750_0/diffnm) %>%
#   mutate(SecondDriveAlt = dAdnm/FirstRange) %>%
#   ungroup()
# ```
# 
# 
# ```{r second deriv plots}
# #set variables for plotting
# groupvar = sym("filename")
# xvar = sym("nm")
# yvar = sym("SecondDeriv")
# # colourvar = sym("pH")
# # rowvar = sym("par_ue")
# # colvar = sym("alkalinity")
# # #filtervar = sym("par_ue")
# 
# second_deriv_plot <- olis_spectra %>%
#   filter(filename != baseline) %>%
#   ggplot() +
#   geom_line(aes(x = !!xvar, y = !!yvar, colour = !!groupvar)) +
#   theme_bw() +
#   facet_wrap(vars(strain), nrow = 2, ncol = 1, ) +
#   coord_cartesian(xlim = c(450, 750), ylim = c(-0.002, 0.002)) +
#   labs(title = "second_deriv_plot")
# 
# second_deriv_plot 
# 
# second_derivalt_plot <- olis_spectra %>%
#   filter(filename != baseline) %>%
#   ggplot() +
#   geom_line(aes(x = !!xvar, y = SecondDriveAlt, colour = !!groupvar)) +
#   theme_bw() +
#   facet_wrap(vars(strain), nrow = 2, ncol = 1, ) +
#   coord_cartesian(xlim = c(450, 750), ylim = c(-0.002, 0.002)) +
#   labs(title = "second_derivalt_plot")
# 
# second_derivalt_plot 
#labels(caption = paste(nm, "nm; PAR", par, "uE"))
#filter(!!filtervar %in% c(0,32,35)) %>%
```


```{r save Olis}

#saveRDS(olis_spectra, file = "olis_spectra.rds")
```


```{r save growth_long}
#saveRDS(growth_long, file = file.path("process_data",paste(project,file_id_single, "growth_long", ".Rds",sep = "_"),fsep = .Platform$file.sep))
```
